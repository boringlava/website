---
title: 'Testing Rmarkdown with GNIP data'
author: mae
date: '2021-02-20'
slug: testing-rmarkdown-with-gnip-data
categories:
  - tech
tags:
  - R
---

**(in progress)**

## Rnotebook setup

This notebook requires a few R packages, listed and loaded below:

```{r, setup, echo=TRUE}
pacman::p_load(here, knitr, blogdown, tidyverse, lubridate, kableExtra, ggthemes)
```

## Viewing data

I've downloaded a small set of data from the [International Atomic Energy Agency Global Network for Isotopes in Precipitation](https://nucleus.iaea.org/wiser) that includes water isotope data collected in the last 15 years from 7 sites around the world. The code chunk that produces this table also cleans up the data for display. The GNIP source doesn't specify units (!!) so I have had to guess.

```{r GNIP-all, echo=FALSE}

waters.all <- read.csv(here("data/water/GNIP-daily_2010-2020.csv"))

kable(waters.all %>%
      select(Site, Country, Date, 
             "Altitude (m)" = Altitude, 
             "d18O VSMOW" = O18, 
             "dD VSMOW" = H2, 
             "Precipitation (mm)" = Precipitation, 
             "Air Temperature (C)" = Air.Temperature, 
             "Vapor pressure" = Vapour.Pressure),
      digits = 2,
      format="html") %>%
      kable_styling() %>%
      scroll_box(height="500px", width="100%") 

```

Getting this to look better will require adjusting the table style in the theme, and messing with kable or another package. Having special characters in a table display would be nice, but since they aren't allowed in column names for raw data, it may not be the best precedent to set.

## Basic ggplots

Here is a basic ggplot for water isotopes, with the code to generate it:

```{r plot-MWL, echo=TRUE, warning=FALSE}

theme_set(theme_tufte(base_family = "Helvetica"))

axis.x.label <- expression(paste(delta^{18}, "O (‰ VSMOW)"))
axis.y.label <- expression(paste(delta, "D (‰ VSMOW)"))

plot.MWL <- ggplot() +
  
  # plot features
  geom_point(data=waters.all %>%
               drop_na(O18, H2), 
             aes(x=O18, y=H2, color=Country), size = 1) +
  geom_abline(data=NULL, aes(slope=8, intercept=10, shape="GMWL")) +
  
  # legend 
  scale_color_colorblind() + 
    # without any adjustments to the legend, this one is haphazard 
  
  # axes and titles
  coord_cartesian() + 
  labs(x = axis.x.label, 
       y = axis.y.label,
       caption = "Global Meteoric Water Line shown in black")

plot(plot.MWL)

```

The second plot shows time series data. The code is hidden, it is very similar to the above, with the addition of a copy of the data set for time series analysis. 

```{r plot-time-temp, echo=FALSE}

# new data frame for time series work 
waters.time <- waters.all %>%
  mutate(Date.Format = ymd(Date))

plot.time.temp <- ggplot() +
  geom_point(data=waters.time %>%
               drop_na(Air.Temperature), 
             aes(x=Date.Format, y=Air.Temperature, color=Country), size=1) +
  
  scale_color_colorblind() +
  scale_x_date(
    date_labels = "%Y",
    date_breaks="1 year") +
  
  # axes and titles
  coord_cartesian() + 
  labs(x = NULL,
       y = "Temperature (°C)")

plot(plot.time.temp)

```

Next, I'd like to plot different variables over time. This could be accomplished with a function that builds ggplots from input variables, but instead, I'll try something new with Shiny, in a subsequent post. Rendering this .Rmd notebook and building with the two ggplots above is already affecting Hugo performance, so I imagine Shiny will as well. 

